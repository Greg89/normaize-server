name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DOTNET_VERSION: '9.0.x'

jobs:
  build-test-coverage:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Build solution
      run: dotnet build --no-restore --configuration Release

    - name: Run tests
      run: dotnet test --no-build --verbosity normal --configuration Release

    - name: Run tests with coverage
      run: dotnet test --no-build --verbosity normal --configuration Release --collect:"XPlat Code Coverage" --results-directory ./coverage

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/**/coverage.cobertura.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: Generate coverage report
      env:
        REPORTGENERATOR_LICENSE: ${{ secrets.REPORTGENERATOR_LICENSE }}
      run: |
        # Install ReportGenerator Pro
        dotnet tool install --global dotnet-reportgenerator-globaltool
        
        # Generate HTML report
        reportgenerator -reports:"./coverage/**/coverage.cobertura.xml" -targetdir:"./coverage-report" -reporttypes:Html
        
        # Generate summary and badges
        reportgenerator -reports:"./coverage/**/coverage.cobertura.xml" -targetdir:"./coverage-summary" -reporttypes:"TextSummary;Badges"

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: ./coverage-report/
        retention-days: 30

    - name: Upload coverage summary
      uses: actions/upload-artifact@v4
      with:
        name: coverage-summary
        path: ./coverage-summary/
        retention-days: 30

    - name: Run security scan
      run: dotnet list package --vulnerable

  docker-build:
    runs-on: ubuntu-latest
    needs: build-test-coverage
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build -t normaize-api .
        echo "Docker image built successfully"
        docker images | grep normaize-api

    - name: Test Docker image
      run: |
        echo "Testing Docker image..."
        
        # Verify image exists and has correct structure
        echo "Checking image details..."
        docker images normaize-api
        
        # Test that the image contains the expected files
        echo "Validating image contents..."
        docker run --rm --entrypoint="" normaize-api ls -la /app/
        
        # Test that the main application DLL exists
        echo "Testing application files..."
        docker run --rm --entrypoint="" normaize-api test -f /app/Normaize.API.dll && echo "✅ Application DLL found"
        
        echo "✅ Docker image test completed"
        echo "Image builds successfully and contains all required files"

  database-migration:
    runs-on: ubuntu-latest
    needs: build-test-coverage
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup MySQL
      run: |
        sudo apt-get update
        sudo apt-get install -y mysql-server mysql-client
        
        # Start MySQL service
        sudo systemctl start mysql
        sudo systemctl enable mysql
        
        # Wait for MySQL to start
        sleep 10
        
        # Create a temporary MySQL configuration to allow root access
        sudo tee /etc/mysql/conf.d/allow-root.cnf > /dev/null <<EOF
        [mysqld]
        skip-grant-tables
        EOF
        
        # Restart MySQL with the new configuration
        sudo systemctl restart mysql
        sleep 5
        
        # Now we can connect without password and set up the root user
        sudo mysql -e "UPDATE mysql.user SET plugin='mysql_native_password', authentication_string=PASSWORD('test123') WHERE user='root';"
        sudo mysql -e "FLUSH PRIVILEGES;"
        
        # Remove the temporary configuration
        sudo rm /etc/mysql/conf.d/allow-root.cnf
        
        # Restart MySQL normally
        sudo systemctl restart mysql
        sleep 5
        
        # Verify the password was set
        mysql -u root -ptest123 -e "SELECT 1;" || echo "Password setup failed"
        
        # Show MySQL status
        sudo systemctl status mysql

    - name: Wait for MySQL
      run: |
        while ! mysql -h 127.0.0.1 -P 3306 -u root -ptest123 -e "SELECT 1" > /dev/null 2>&1; do
          echo "Waiting for MySQL to be ready..."
          sleep 2
        done
        echo "✅ MySQL is ready"

    - name: Create database
      run: |
        mysql -h 127.0.0.1 -P 3306 -u root -ptest123 -e "CREATE DATABASE IF NOT EXISTS normaize;"

    - name: Apply EF Core Migration
      run: |
        cd Normaize.Data
        dotnet ef database update --startup-project ../Normaize.API --connection "Server=127.0.0.1;Database=normaize;User=root;Password=test123;CharSet=utf8mb4;"

    - name: Verify Migration
      run: |
        echo "Verifying database migration..."
        
        # Check if tables exist
        mysql -h 127.0.0.1 -P 3306 -u root -ptest123 normaize -e "SHOW TABLES;"
        
        # Check if DataSets table exists and has expected columns
        mysql -h 127.0.0.1 -P 3306 -u root -ptest123 normaize -e "DESCRIBE DataSets;"
        
        echo "✅ Database migration verification completed"

  deploy-coverage-pages:
    runs-on: ubuntu-latest
    needs: build-test-coverage
    if: github.ref == 'refs/heads/main'
    permissions:
      pages: write
      id-token: write
      contents: read
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download coverage report
      uses: actions/download-artifact@v4
      with:
        name: coverage-report
        path: ./coverage-report/

    - name: Debug repository info
      run: |
        echo "Repository: ${{ github.repository }}"
        echo "Repository owner: ${{ github.repository_owner }}"
        echo "Repository name: ${{ github.event.repository.name }}"
        echo "GitHub server URL: ${{ github.server_url }}"
        echo "Current ref: ${{ github.ref }}"
        echo "Current SHA: ${{ github.sha }}"
        echo "Repository visibility: ${{ github.event.repository.private }}"

    - name: Check repository access
      run: |
        # Test if we can access the repository
        if git ls-remote --exit-code origin > /dev/null 2>&1; then
          echo "✅ Repository access confirmed"
          echo "REPO_ACCESS=true" >> $GITHUB_ENV
        else
          echo "❌ Repository access failed"
          echo "REPO_ACCESS=false" >> $GITHUB_ENV
        fi

    - name: Setup Pages
      if: env.REPO_ACCESS == 'true'
      uses: actions/configure-pages@v4
      with:
        enablement: true

    - name: Upload to GitHub Pages
      if: env.REPO_ACCESS == 'true'
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./coverage-report/

    - name: Deploy to GitHub Pages
      if: env.REPO_ACCESS == 'true'
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Skip deployment - Access issues
      if: env.REPO_ACCESS == 'false'
      run: |
        echo "⚠️ Skipping GitHub Pages deployment due to repository access issues"
        echo "This might be due to repository permissions or configuration"
        echo "Please check your GitHub Pages settings in the repository"
        echo ""
        echo "For private repositories with GitHub Pro:"
        echo "1. Ensure GitHub Pages is enabled in repository settings"
        echo "2. Check that the repository has proper permissions"
        echo "3. Verify that GitHub Pro features are enabled for this repository"

  coverage-summary:
    runs-on: ubuntu-latest
    needs: build-test-coverage
    if: always()

    steps:
    - name: Download coverage summary
      uses: actions/download-artifact@v4
      with:
        name: coverage-summary
        path: coverage-summary/

    - name: Display coverage summary
      run: |
        if [ -f "coverage-summary/Summary.txt" ]; then
          echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          cat coverage-summary/Summary.txt >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
        else
          echo "No coverage summary found"
        fi

    - name: Upload coverage badges
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-badges
        path: coverage-summary/
        retention-days: 30 